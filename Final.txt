// This is my Hardware Mini Project...
// The project is Car Parking by Ultrasonic Sensor with Safety Using Arduino UNO.

#include <Wire.h>
#include <LiquidCrystal_I2C.h>
#include <Servo.h>
#include <math.h>

// LCD setup
LiquidCrystal_I2C lcd(0x27, 16, 2);

// Slot-1
const int trig1 = 2;
const int echo1 = 3;
const int buzzer1 = 4;
const int redLED1 = 8;
const int greenLED1 = 9;

// Slot-2
const int trig2 = 5;
const int echo2 = 6;
const int buzzer2 = 7;
const int redLED2 = 10;
const int greenLED2 = 11;

// IR Sensor and Servo Motor defining
const int irSensor = 12;
Servo gateServo;

// Constants for giving conditions
const int parkThreshold = 3;
const int warnDistance = 1;
const int fullyParkedLimit = 2;
const int spacingLimit = 13;
const int parkingIn = 7;

bool slot1Occupied = false;
bool slot2Occupied = false;

unsigned long slot1StartTime = 0;
unsigned long slot2StartTime = 0;

int charge1 = 0;
int charge2 = 0;

void setup() 
{
  lcd.init();
  lcd.backlight();

  pinMode(trig1, OUTPUT); pinMode(echo1, INPUT);
  pinMode(buzzer1, OUTPUT); pinMode(redLED1, OUTPUT); pinMode(greenLED1, OUTPUT);

  pinMode(trig2, OUTPUT); pinMode(echo2, INPUT);
  pinMode(buzzer2, OUTPUT); pinMode(redLED2, OUTPUT); pinMode(greenLED2, OUTPUT);

  pinMode(irSensor, INPUT);

  gateServo.attach(13);
  gateServo.write(0); // Gate initially closed

  lcd.setCursor(0, 0);
  lcd.print("Initializing...");
  delay(2000);

  lcd.setCursor(0, 0);
  lcd.print("Welcome To ");
  delay(1500);

  lcd.setCursor(0, 0);
  lcd.print("Car Parking Sys");
  delay(2000);

  lcd.clear();
}

void loop() 
{
  int dist1 = getDistance(trig1, echo1);
  int dist2 = getDistance(trig2, echo2);

  String status1 = "", status2 = "";

  unsigned long currentTime = millis();

  // SLOT-1 LOGIC
  if (dist1 >= warnDistance && dist1 <= fullyParkedLimit) 
  {
    digitalWrite(buzzer1, HIGH);
    digitalWrite(redLED1, HIGH); 
    digitalWrite(greenLED1, LOW);

    status1 = "S1: Approaching";
    slot1Occupied = false;

    slot1StartTime = 0;
    charge1 = 0;
  } else if (dist1 >= parkThreshold && dist1 <= parkingIn) 
  {
    digitalWrite(buzzer1, LOW);
    digitalWrite(redLED1, HIGH); 
    digitalWrite(greenLED1, LOW);

    if (!slot1Occupied) 
    {
      beep(buzzer1);

      slot1StartTime = currentTime;
      charge1 = 5;
    } else 
    {
      unsigned long elapsed1 = (currentTime - slot1StartTime) / 10000;
      charge1 = 5 * (2, elapsed1);
    }
    slot1Occupied = true;
    status1 = "S1: Parked";
  } else if (dist1 >= parkingIn && dist1 <= spacingLimit) 
  {
    digitalWrite(buzzer1, LOW);
    digitalWrite(redLED1, LOW); 
    digitalWrite(greenLED1, HIGH);

    status1 = "S1: Parking";
    slot1Occupied = false;

    slot1StartTime = 0;
    charge1 = 0;
  } else 
  {
    digitalWrite(buzzer1, LOW);
    digitalWrite(redLED1, LOW); 
    digitalWrite(greenLED1, HIGH);

    status1 = "S1: Empty";
    slot1Occupied = false;

    slot1StartTime = 0;
    charge1 = 0;
  }

  // SLOT-2 LOGIC
  if (dist2 >= warnDistance && dist2 <= fullyParkedLimit) 
  {
    digitalWrite(buzzer2, HIGH);
    digitalWrite(redLED2, HIGH); 
    digitalWrite(greenLED2, LOW);

    status2 = "S2: Approaching";
    slot2Occupied = false;

    slot2StartTime = 0;
    charge2 = 0;
  } else if (dist2 >= parkThreshold && dist2 <= parkingIn) 
  {
    digitalWrite(buzzer2, LOW);
    digitalWrite(redLED2, HIGH); 
    digitalWrite(greenLED2, LOW);

    if (!slot2Occupied) 
    {
      beep(buzzer2);

      slot2StartTime = currentTime;
      charge2 = 5;
    } else 
    {
      unsigned long elapsed2 = (currentTime - slot2StartTime) / 10000;
      charge2 = 5 * (2, elapsed2);
    }
    slot2Occupied = true;
    status2 = "S2: Parked";
  } else if (dist2 >= parkingIn && dist2 <= spacingLimit) 
  {
    digitalWrite(buzzer2, LOW);
    digitalWrite(redLED2, LOW); 
    digitalWrite(greenLED2, HIGH);

    status2 = "S2: Parking";
    slot2Occupied = false;

    slot2StartTime = 0;
    charge2 = 0;
  } else 
  {
    digitalWrite(buzzer2, LOW);
    digitalWrite(redLED2, LOW); 
    digitalWrite(greenLED2, HIGH);

    status2 = "S2: Empty";
    slot2Occupied = false;

    slot2StartTime = 0;
    charge2 = 0;
  }

  // --- Advanced Gate Logic: Open on departure ---
  static bool prevSlot1Occupied = false;
  static bool prevSlot2Occupied = false;
  static bool carExiting = false;

  int irState = digitalRead(irSensor);

  bool slot1Leaving = prevSlot1Occupied && dist1 > spacingLimit;
  bool slot2Leaving = prevSlot2Occupied && dist2 > spacingLimit;

  if ((slot1Leaving || slot2Leaving) && !carExiting) 
  {
    carExiting = true;
    gateServo.write(90); // Open gate
  }

  if (carExiting) 
  {
    if (irState == HIGH) 
    {
      delay(10000); // 10-second delay before closing

      gateServo.write(0);  // Close gate once car has left
      carExiting = false;
    }
  } else if (irState == LOW && !(slot1Occupied && slot2Occupied)) 
  {
    gateServo.write(90); // Open for entry if space
  } else 
  {
    gateServo.write(0); // Default closed
  }

  prevSlot1Occupied = slot1Occupied;
  prevSlot2Occupied = slot2Occupied;

  // LCD Update
  lcd.clear();
  if (slot1Occupied) 
  {
    lcd.setCursor(0, 0);
    lcd.print(status1 + " C1:" + String(charge1));
  } else 
  {
    lcd.setCursor(0, 0);
    lcd.print(status1);
  }

  if (slot2Occupied) 
  {
    lcd.setCursor(0, 1);
    lcd.print(status2 + " C2:" + String(charge2));
  } else 
  {
    lcd.setCursor(0, 1);
    lcd.print(status2);
  }

  delay(500);
}

// Distance Calculation Function
int getDistance(int trigPin, int echoPin) 
{
  digitalWrite(trigPin, LOW); 
  delayMicroseconds(2);

  digitalWrite(trigPin, HIGH); 
  delayMicroseconds(10);

  digitalWrite(trigPin, LOW);

  long duration = pulseIn(echoPin, HIGH, 30000);
  int distance = duration * 0.034 / 2;
  return (distance == 0 || distance > 400) ? 400 : distance;
}

// Beep Function
void beep(int pin) 
{
  digitalWrite(pin, HIGH);
  delay(150);
  digitalWrite(pin, LOW);
}